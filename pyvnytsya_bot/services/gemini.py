import google.generativeai as genai
from ..config import config

class AIService:
    def __init__(self):
        genai.configure(api_key=config.GEMINI_API_KEY.get_secret_value())
        self.model = genai.GenerativeModel('gemini-2.5-flash') 

    async def generate_scenario(self) -> str:
        prompt = (
            "–¢–∏ - –≤–µ–¥—É—á–∏–π –≥—Ä–∏ '–ë—É–Ω–∫–µ—Ä'. –ü—Ä–∏–¥—É–º–∞–π –¥–µ—Ç–∞–ª—å–Ω–∏–π —Ç–∞ –∞—Ç–º–æ—Å—Ñ–µ—Ä–Ω–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∏. "
            "–¢–≤–æ—è –≤—ñ–¥–ø–æ–≤—ñ–¥—å –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ —Ç–∞–∫—ñ –ø—É–Ω–∫—Ç–∏:\n"
            "1. **–ö–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞**: –©–æ —Å—Ç–∞–ª–æ—Å—è —É —Å–≤—ñ—Ç—ñ (—è–¥–µ—Ä–Ω–∞ –≤—ñ–π–Ω–∞, –≤—ñ—Ä—É—Å, –∑–æ–º–±—ñ, –∫–ª—ñ–º–∞—Ç —Ç–æ—â–æ).\n"
            "2. **–ë—É–Ω–∫–µ—Ä**: –û–ø–∏—à–∏ –π–æ–≥–æ —Ç–µ—Ö–Ω—ñ—á–Ω–∏–π —Å—Ç–∞–Ω. –í–∫–∞–∂–∏ –ø–ª–æ—â—É (—É –º¬≤), –ø–µ—Ä–µ–ª—ñ–∫ –ø—Ä–∞—Ü—é—é—á–∏—Ö —Å–∏—Å—Ç–µ–º/–∫—ñ–º–Ω–∞—Ç (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–Ω–∞, —Å–∫–ª–∞–¥, –∫—É—Ö–Ω—è) "
            "—Ç–∞ –ø–µ—Ä–µ–ª—ñ–∫ –∑–ª–∞–º–∞–Ω–∏—Ö –∞–±–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö –ø—Ä–∏–º—ñ—â–µ–Ω—å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: –≤–µ–Ω—Ç–∏–ª—è—Ü—ñ—è, –º–µ–¥–ø—É–Ω–∫—Ç).\n"
            "3. **–£–º–æ–≤–∏**: –°–∫—ñ–ª—å–∫–∏ —á–∞—Å—É (—Ä–æ–∫—ñ–≤/–º—ñ—Å—è—Ü—ñ–≤) –≥—Ä—É–ø—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø—Ä–æ–∂–∏—Ç–∏ –≤ –±—É–Ω–∫–µ—Ä—ñ –¥–æ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –¥–≤–µ—Ä–µ–π.\n"
            "–í—ñ–¥–ø–æ–≤—ñ–¥—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é. –ó—Ä–æ–±–∏ –æ–ø–∏—Å —Ü—ñ–∫–∞–≤–∏–º, —â–æ–± –≥—Ä–∞–≤—Ü—è–º –±—É–ª–æ —Å—Ç—Ä–∞—à–Ω–æ –∞–±–æ –≤–µ—Å–µ–ª–æ."
        )
        response = await self.model.generate_content_async(prompt)
        return response.text

    async def generate_ending(self, survivors_info: str, scenario: str) -> str:
        prompt = (
            f"–¢–∏ - –≤–µ–¥—É—á–∏–π –≥—Ä–∏ '–ë—É–Ω–∫–µ—Ä'. –ì—Ä–∞ –∑–∞–∫—ñ–Ω—á–∏–ª–∞—Å—è.\n\n"
            f"üìú **–ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π:**\n{scenario}\n\n"
            f"üë• **–°–ø–∏—Å–æ–∫ —Ç–∏—Ö, —Ö—Ç–æ –∑–∞–ª–∏—à–∏–≤—Å—è –≤ –±—É–Ω–∫–µ—Ä—ñ:**\n{survivors_info}\n\n"
            "–ù–∞–ø–∏—à–∏ —Ä–æ–∑–≥–æ—Ä–Ω—É—Ç—É –∫—ñ–Ω—Ü—ñ–≤–∫—É —ñ—Å—Ç–æ—Ä—ñ—ó, –≤—Ä–∞—Ö–æ–≤—É—é—á–∏ –ø–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π (—Å—Ç–∞–Ω –±—É–Ω–∫–µ—Ä–∞, –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ—É, —Ç–µ—Ä–º—ñ–Ω –ø–µ—Ä–µ–±—É–≤–∞–Ω–Ω—è). –¢–≤–æ—î –∑–∞–≤–¥–∞–Ω–Ω—è:\n"
            "1. –ü—Ä–æ–∞–Ω–∞–ª—ñ–∑—É–≤–∞—Ç–∏ —Å–∫–ª–∞–¥ –≥—Ä—É–ø–∏: —á–∏ —î —Å–µ—Ä–µ–¥ –Ω–∏—Ö –ª—ñ–∫–∞—Ä, —ñ–Ω–∂–µ–Ω–µ—Ä, –±—ñ–æ–ª–æ–≥? –ß–∏ —î –ª—é–¥–∏ –∑ –Ω–µ–±–µ–∑–ø–µ—á–Ω–∏–º–∏ —Ö–≤–æ—Ä–æ–±–∞–º–∏ –∞–±–æ –º–∞–Ω—ñ—è–∫–∏?\n"
            "2. –û–ø–∏—Å–∞—Ç–∏, —è–∫ –ø—Ä–æ–π—à–æ–≤ —ó—Ö–Ω—ñ–π —á–∞—Å —É –±—É–Ω–∫–µ—Ä—ñ (–∫–æ–Ω—Ñ–ª—ñ–∫—Ç–∏, –¥–æ–ø–æ–º–æ–≥–∞, –∫—Ä–∏–∑–∏, —Ä–µ–º–æ–Ω—Ç —Å–∏—Å—Ç–µ–º).\n"
            "3. **–ó—Ä–æ–±–∏—Ç–∏ —á—ñ—Ç–∫–∏–π –≤–∏—Å–Ω–æ–≤–æ–∫**: –ß–ò –í–ò–ñ–ò–õ–ê –ì–†–£–ü–ê? (–¢–∞–∫/–ù—ñ/–ß–∞—Å—Ç–∫–æ–≤–æ).\n"
            "–Ø–∫—â–æ –≤–æ–Ω–∏ –∑–∞–≥–∏–Ω—É–ª–∏ - –æ–ø–∏—à–∏ –ø—Ä–∏—á–∏–Ω—É (–≥–æ–ª–æ–¥, —Ö–≤–æ—Ä–æ–±–∞, –≤–±–∏–≤—Å—Ç–≤–æ, –ø–æ–ª–æ–º–∫–∞ —Å–∏—Å—Ç–µ–º). "
            "–Ø–∫—â–æ –≤–∏–∂–∏–ª–∏ - –æ–ø–∏—à–∏, —â–æ –≤–æ–Ω–∏ –ø–æ–±–∞—á–∏–ª–∏, –∫–æ–ª–∏ –≤–∏–π—à–ª–∏ –Ω–∞–∑–æ–≤–Ω—ñ.\n"
            "–í—ñ–¥–ø–æ–≤—ñ–¥—å —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é."
        )
        try:
            response = await self.model.generate_content_async(prompt)
            if response and response.text:
                return response.text
            else:
                return "–Ü—Å—Ç–æ—Ä—ñ—è –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—è –º–æ–≤—á–∞–Ω–Ω—è–º..."
        except Exception as e:
            raise Exception(f"Failed to generate ending: {e}")

ai_service = AIService()
